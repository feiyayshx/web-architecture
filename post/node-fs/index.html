<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    Nodeç³»åˆ—ä¹‹fsæ¨¡å— | å¢¨çœ‰
</title>
<link rel="shortcut icon" href="https://feiyayshx.github.io/web-architecture/favicon.ico?v=1603441319926">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://feiyayshx.github.io/web-architecture/styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://feiyayshx.github.io/web-architecture/media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


        
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://feiyayshx.github.io/web-architecture">
                <img class="avatar" src="https://feiyayshx.github.io/web-architecture/images/avatar.png?v=1603441319926" alt="">
            </a>
            <div class="site-title">
                <h1>
                    å¢¨çœ‰
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                        <li>
                            <a href="https://feiyayshx.github.io/web-architecture" class="menu" target="_blank">
                                é¦–é¡µ
                            </a>
                        </li>
                        
                                
                    
                            <li>
                                <a href="https://feiyayshx.github.io/web-architecture/archives" class="menu">
                                    å½’æ¡£
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="https://feiyayshx.github.io/web-architecture/tags" class="menu">
                                    æ ‡ç­¾
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="https://feiyayshx.github.io/web-architecture/post/about" class="menu">
                                    å…³äº
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            Nodeç³»åˆ—ä¹‹fsæ¨¡å—
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2020-09-28 09:47</time>
                            
                                <a href="https://feiyayshx.github.io/web-architecture/tag/node/" class="post-tag i-tag
                            i-tag-banana">
                            #Node
                        </a>
                                
                        </div>
                        
                                <div class="post-content">
                                    <p>ğŸ‘ fsæ¨¡å—ç”¨äºä¸æ–‡ä»¶ç³»ç»Ÿäº¤äº’ï¼Œæ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œéƒ½å…·æœ‰åŒæ­¥çš„ã€å›è°ƒçš„ã€ä»¥åŠåŸºäº promise çš„å½¢å¼ã€‚</p>
<!-- more -->
<h2 id="ç›¸å…³åè¯">ç›¸å…³åè¯</h2>
<ul>
<li>æ–‡ä»¶æè¿°ç¬¦</li>
</ul>
<h2 id="fsæ–¹æ³•">fsæ–¹æ³•</h2>
<ul>
<li>fs.copyFile()</li>
<li>fs.access()</li>
</ul>
<h2 id="æ–‡ä»¶æ‹·è´ç®€å•ç‰ˆ">æ–‡ä»¶æ‹·è´(ç®€å•ç‰ˆ)</h2>
<ul>
<li>fs æ“ä½œæ¥å—çš„æ–‡ä»¶è·¯å¾„å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€Buffer,æˆ–URLå¯¹è±¡;</li>
<li>å¦‚æœè¯»å–æ–‡ä»¶ï¼Œè¯»åˆ°çš„ç»“æœé»˜è®¤æ˜¯bufferç±»å‹;</li>
<li>å†™å…¥çš„æ—¶å€™ ä¼šæ¸…ç©ºæ–‡ä»¶å†…å®¹ï¼Œå¹¶ä¸”ä»¥utf8æ ¼å¼ç±»å‹å†™å…¥;</li>
</ul>
<pre><code class="language-javascript">
// å°†æ–‡ä»¶homework.jsä¸­çš„å†…å®¹æ‹·è´åˆ°demo.jsä¸­
const fs = require('fs')
const path = require('path')
fs.readFile(path.resolve(__dirname,'homework.js'),function(err,data) {
  fs.appendFile(path.resolve(__dirname,'demo.js'),data,function(err){
    console.log('copy finished')
  })
})

</code></pre>
<blockquote>
<p>æ³¨æ„ï¼šè¿è¡Œæ—¶å¦‚æœç”¨ç›¸å¯¹è·¯å¾„ï¼Œä¼šä»¥process.cwd() æ¥åˆ‡æ¢è·¯å¾„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸åŒè·¯å¾„ä¸‹è¿è¡Œç»“æœä¸åŒã€‚æ•…ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚</p>
</blockquote>
<p><strong>ç¼ºç‚¹:</strong></p>
<ul>
<li>è¯»å–æ–‡ä»¶æ—¶ï¼Œè¯»å–çš„å†…å®¹æ”¾åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæ–‡ä»¶è¿‡å¤§ä¼šæµªè´¹å†…å­˜ï¼Œæ·¹æ²¡å¯ç”¨å†…å­˜ï¼Œå¤§å‹æ–‡ä»¶ä¸èƒ½é‡‡ç”¨æ­¤æ–¹å¼æ“ä½œï¼›ä¸€èˆ¬64kb ä»¥ä¸Šçš„æ–‡ä»¶å®ç°æ‹·è´å°½é‡ä¸è¦ä½¿ç”¨readFileæ–¹æ³•ã€‚</li>
</ul>
<h2 id="æ–‡ä»¶æ‹·è´æ”¹è¿›ç‰ˆ">æ–‡ä»¶æ‹·è´(æ”¹è¿›ç‰ˆ)</h2>
<p>ç®€å•ç‰ˆçš„æ–‡ä»¶æ‹·è´ä¸é€‚åˆè¯»å–å¤§æ–‡ä»¶ï¼Œå®¹æ˜“é€ æˆå†…å­˜æµªè´¹; å¯¹äºè¯»å–å¤§å‹æ–‡ä»¶çš„åœºæ™¯ï¼Œéœ€è¦åˆ†æ®µè¯»å–æ–‡ä»¶ï¼Œå®ç°è¯»å–ä¸€ç‚¹å†™å…¥ä¸€ç‚¹ï¼›æ ¸å¿ƒæ–¹æ³•æœ‰ï¼šfs.open()ã€fs.read()ã€fs.write()ã€fs.close()ã€‚</p>
<pre><code class="language-javascript">
const fs = require('fs')
function copyFile(source, target, callback) {
  const BUFFER_LENGTH = 6
  let readPosition = 0
  let writePosition = 0
  const buffer = Buffer.alloc(BUFFER_LENGTH)
  // æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–å†…å®¹
  fs.open(source, 'r', function (err, rfd) {
    // æ‰“å¼€æ–‡ä»¶ï¼Œå†™å…¥å†…å®¹
    fs.open(target, 'w', function (err, wfd) {
      function copy() {
        fs.read(rfd, buffer, 0, BUFFER_LENGTH, readPosition, function (err, bytesRead) {
          // è¯»å–åˆ°çš„å®é™…å­—èŠ‚æ•°
          if (err) return callback(err)
          if (bytesRead) {
            // å°†è¯»å–çš„æ•°æ®å†™å…¥æ–‡ä»¶
            fs.write(wfd, buffer, 0, bytesRead, writePosition, function (err, written) {
              readPosition += bytesRead
              writePosition += bytesRead
              copy();
            })
          } else {
            fs.close(rfd, () =&gt; { })
            fs.close(wfd, () =&gt; { })
            callback()
          }
        })
      }
      copy()
    })
  })
}

/*---------åŠŸèƒ½æµ‹è¯•----------*/
copyFile('./3.fs.js', './demo.js', function () {
  console.log('copy finished')
})

</code></pre>
<h2 id="æ–‡ä»¶æ‹·è´ç»ˆæç‰ˆ">æ–‡ä»¶æ‹·è´(ç»ˆæç‰ˆ)</h2>
<p>æ–‡ä»¶æ‹·è´çš„ç»ˆæç‰ˆæ˜¯å¯¹æ”¹è¿›ç‰ˆçš„ä¸€ç§ä¼˜åŒ–ï¼›fs åŸºäºæµå°è£…äº†æ–‡ä»¶çš„å¯è¯»æµæ–¹æ³•fs.createReadStreamå’Œå¯å†™æµæ–¹æ³•fs.createWriteStreamã€‚</p>
<h3 id="fscreatereadstream-å¯è¯»æµå†…éƒ¨å®ç°è¿‡ç¨‹åŠç”¨æ³•">fs.createReadStream å¯è¯»æµå†…éƒ¨å®ç°è¿‡ç¨‹åŠç”¨æ³•</h3>
<p>å®ç°äº†stream.Readableæ¥å£çš„å¯¹è±¡ï¼Œå°†å¯¹è±¡æ•°æ®è¯»å–ä¸ºæµæ•°æ®ï¼›</p>
<ul>
<li>
<ol>
<li>å†…éƒ¨è°ƒç”¨ new ReadStream, ç»§æ‰¿äºReadableæ¥å£ï¼›</li>
</ol>
</li>
<li>
<ol start="2">
<li>å…ˆè¿›è¡Œæ•°æ®æ ¼å¼åŒ–ï¼›</li>
</ol>
</li>
<li>
<ol start="3">
<li>é»˜è®¤æ‰“å¼€æ–‡ä»¶ï¼ŒReadStream.prototype.read</li>
</ol>
</li>
<li>
<ol start="4">
<li>Readable.prototype.read -&gt;  ReadStream.prototype._read</li>
</ol>
</li>
</ul>
<blockquote>
<p>æƒ³åŸºäºReadableæ¥å£å®ç°è‡ªå·±çš„å¯è¯»æµ ä½ éœ€è¦è‡ªå·±å»å®ç°ä¸€ä¸ª_readæ–¹æ³•ï¼Œé»˜è®¤å¼€å§‹è¯»å–æ—¶ä¼šå»è°ƒç”¨æ­¤æ–¹æ³•.<br>
å¯è¯»æµå¯¹è±¡ å¿…é¡»æœ‰on('data') on('end')  , æ–‡ä»¶æµä¼šæä¾›ä¸¤ä¸ªæ–¹æ³• open/close<br>
æ§åˆ¶è¯»å–é€Ÿç‡ rs.pause rs.resume</p>
</blockquote>
<h4 id="åˆ›å»ºå¯è¯»æµ">åˆ›å»ºå¯è¯»æµ</h4>
<pre><code class="language-javascript">
const fs = require('fs')
const path = require('path')

let readStream = fs.createReadStream(path.resolve(__dirname, 'demo.md'), {
  flags: 'r', // å¯è¯»æ€§æ ‡è¯†ï¼Œé»˜è®¤å€¼'r',è¯»å–æ–‡ä»¶
  encoding: null, // ç¼–ç ï¼Œé»˜è®¤null
  autoClose: false, // è¯»å–å®Œæ¯•åè‡ªåŠ¨å…³é—­ï¼Œé»˜è®¤true
  start: 0, // ä»æ–‡ä»¶ä¸­æŒ‡å®šå¼€å§‹ä½ç½®è¯»å–ï¼ŒåŒ…æ‹¬è¯¥ä½ç½®
  end: 4,   // æŒ‡å®šè¯»å–æ–‡ä»¶çš„ç»“æŸä½ç½®ï¼ŒåŒ…æ‹¬è¯¥ä½ç½®
  highWaterMark: 2 // æ¯æ¬¡è¯»å–çš„å­—èŠ‚æ•°ï¼Œé»˜è®¤64 * 1024 ä¸ªå­—èŠ‚

})

</code></pre>
<h4 id="ç›‘å¬dataäº‹ä»¶">ç›‘å¬dataäº‹ä»¶</h4>
<p>æµåˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼,æ•°æ®ä¼šè¢«å°½å¯èƒ½å¿«çš„è¯»å‡º</p>
<pre><code class="language-javascript">
let arr = []
// é»˜è®¤ä¸€æ—¦ç›‘å¬dataäº‹ä»¶ï¼Œä¼šä¸åœè§¦å‘dataæ–¹æ³•
readStream.on('data', function (chunk) {
  arr.push(chunk)
})
</code></pre>
<h4 id="ç›‘å¬endäº‹ä»¶">ç›‘å¬endäº‹ä»¶</h4>
<p>æ•°æ®è¯»å–å®Œæ¯•ï¼Œè§¦å‘endäº‹ä»¶</p>
<pre><code class="language-javascript">
readStream.on('end', function () {
  console.log(Buffer.concat(arr), 'æ–‡ä»¶è¯»å–å®Œæ¯•ï¼')
})
</code></pre>
<h4 id="ç›‘å¬erroräº‹ä»¶">ç›‘å¬erroräº‹ä»¶</h4>
<pre><code class="language-javascript">
readStream.on('error', function (err) {
  console.log(err)
})
</code></pre>
<h4 id="ç›‘å¬openäº‹ä»¶">ç›‘å¬openäº‹ä»¶</h4>
<pre><code class="language-javascript">
readStream.on('open', function (fd) {
  console.log(fd, 'open æ‰“å¼€æ–‡ä»¶')
})
</code></pre>
<h4 id="ç›‘å¬colseäº‹ä»¶">ç›‘å¬colseäº‹ä»¶</h4>
<pre><code class="language-javascript">
readStream.on('close',function(){
  console.log('close å…³é—­æ–‡ä»¶')
})
</code></pre>
<h4 id="è®¾ç½®ç¼–ç ">è®¾ç½®ç¼–ç </h4>
<p><code>readStream.setEncoding('utf8')</code></p>
<h4 id="æš‚åœå’Œæ¢å¤è§¦å‘data">æš‚åœå’Œæ¢å¤è§¦å‘data</h4>
<pre><code class="language-javascript">
readStream.on('data', function (data) {
    readStream.pause();  // æš‚åœè¯»å–
    console.log(data);
});
setTimeout(function () {
    readStream.resume(); // è¯»å–
},2000);
</code></pre>
<h3 id="fscreatewritestream-å¯å†™æµç”¨æ³•">fs.createWriteStream å¯å†™æµç”¨æ³•</h3>
<p>å®ç°äº†stream.Writeable æ¥å£å¯¹è±¡ï¼Œå°†æµæ•°æ®å†™å…¥åˆ°å¯¹è±¡ä¸­</p>
<h4 id="åˆ›å»ºå¯å†™æµ">åˆ›å»ºå¯å†™æµ</h4>
<pre><code class="language-javascript">
const fs = require('fs');
const path = require('path');

const ws = fs.createWriteStream(path.resolve(__dirname, 'test.txt'),{
    flags:'w',
    encoding:'utf8',
    autoClose:true,
    highWaterMark: 2// é»˜è®¤å†™çš„æ°´ä½çº¿æ˜¯16k
});

</code></pre>
<h4 id="write-æ–¹æ³•">write() æ–¹æ³•</h4>
<p><code>ws.write(chunk,[encoding],[callback])</code></p>
<ul>
<li>chunk: string/buffer</li>
<li>encoding: ç¼–ç æ ¼å¼chunkä¸ºå­—ç¬¦ä¸²æ—¶æœ‰ç”¨ï¼Œå¯é€‰</li>
<li>callback: å†™å…¥æˆåŠŸåçš„å›è°ƒ</li>
</ul>
<blockquote>
<p>è¿”å›å€¼ä¸ºå¸ƒå°”å€¼ï¼Œç³»ç»Ÿç¼“å­˜åŒºæ»¡æ—¶ä¸ºfalse,æœªæ»¡æ—¶ä¸ºtrue</p>
</blockquote>
<h4 id="end-æ–¹æ³•">end() æ–¹æ³•</h4>
<p><code>ws.end(chunk,[encoding],[callback])</code><br>
å¯ä»¥åœ¨å…³é—­æµä¹‹å‰å†å†™å…¥ä¸€æ®µæ•°æ® å¦‚æœä¼ å…¥äº†å¯é€‰çš„ callback å‡½æ•°ï¼Œå®ƒå°†ä½œä¸º 'finish' äº‹ä»¶çš„å›è°ƒå‡½æ•°;</p>
<h4 id="drain-æ–¹æ³•">drain() æ–¹æ³•</h4>
<ul>
<li>å½“æµä¸å¤„åœ¨drainçŠ¶æ€æ—¶ï¼Œå¯¹write()çš„è°ƒç”¨ä¼šç¼“å­˜æ•°æ®å—ï¼Œè¿”å›false;å½“å‰æ‰€æœ‰ç¼“å­˜çš„æ•°æ®å—éƒ½æ¸…ç©ºåï¼Œä¼šè§¦å‘drain()äº‹ä»¶ï¼›</li>
</ul>
<pre><code class="language-javascript">
let fs = require('fs');
let ws = fs.createWriteStream('./demo.md',{
  flags:'w',
  encoding:'utf8',
  highWaterMark:3
});
let i = 10;
function write(){
 let  flag = true;
 while(i&amp;&amp;flag){
      flag = ws.write(&quot;1&quot;);
      i--;
     console.log(flag);
 }
}
write();
ws.on('drain',()=&gt;{
  console.log(&quot;drain&quot;);
  write();
});

</code></pre>
<h4 id="finish-æ–¹æ³•">finish() æ–¹æ³•</h4>
<p>åœ¨è°ƒç”¨äº† stream.end() æ–¹æ³•ï¼Œä¸”ç¼“å†²åŒºæ•°æ®éƒ½å·²ç»ä¼ ç»™åº•å±‚ç³»ç»Ÿä¹‹åï¼Œ 'finish' äº‹ä»¶å°†è¢«è§¦å‘ã€‚</p>
<pre><code class="language-javascript">
for (let i = 0; i &lt; 100; i++) {
  ws.write(`hello, ${i}!\n`);
}
ws.end('ç»“æŸ\n');
ws.on('finish', () =&gt; {
  console.error('æ‰€æœ‰çš„å†™å…¥å·²ç»å®Œæˆ!');
});

</code></pre>
<h3 id="å€ŸåŠ©fsæ¨¡å—æä¾›çš„å¯è¯»æµä¸å¯å†™æµæ–¹æ³•å®ç°æ‹·è´">å€ŸåŠ©fsæ¨¡å—æä¾›çš„å¯è¯»æµä¸å¯å†™æµæ–¹æ³•å®ç°æ‹·è´</h3>
<pre><code class="language-javascript">
const fs = require('fs')
let readStream = fs.createReadStream('./3.fs.js', { highWaterMark: 4 })
let writeStream = fs.createWriteStream('./demo.js', { highWaterMark: 2 })
readStream.pipe(writeStream)

</code></pre>
<h2 id="æ–‡ä»¶å¯è¯»æµçš„ç®€å•å®ç°">æ–‡ä»¶å¯è¯»æµçš„ç®€å•å®ç°</h2>
<pre><code class="language-javascript">
const fs = require('fs');
const EventEmitter = require('events')
class ReadStream extends EventEmitter {
  constructor(path, options = {}) {
    super()
    this.path = path;
    this.flags = options.flags || 'r';
    this.encoding = options.encoding || null;
    if (typeof options.autoClose == &quot;undefined&quot;) {
      this.autoClose = true
    } else {
      this.autoClose = options.autoClose
    }
    this.start = options.start || 0;
    this.end = options.end || undefined;
    this.highWaterMark = options.highWaterMark || 64 * 1024;
    this.open(); // é»˜è®¤å°±è°ƒç”¨å¼€å¯äº‹ä»¶
    this.offset = this.start; // offset å¯ä»¥æ ¹æ®æ¯æ¬¡è¯»å–çš„ä½ç½®å‘ç”Ÿå˜åŒ– 
    this.flowing = false; // é»˜è®¤å°±æ˜¯éæµåŠ¨æ¨¡å¼
    this.on('newListener', (type) =&gt; {
      if (type == 'data') { // è¯´æ˜ç”¨æˆ·ç›‘å¬äº†dataäº‹ä»¶
        this.flowing = true;

        this.read(); // è¯»å–å§
      }
    });
  }
  pipe(ws) {
    this.on('data', (chunk) =&gt; {
      let flag = ws.write(chunk);
      if (!flag) {
        this.pause();
      }
    })
    ws.on('drain', () =&gt; {
      this.resume();
    })
  }
  pause() {
    this.flowing = false;
  }
  resume() {
    if (!this.flowing) {
      this.flowing = true;
      this.read(); // ç»§ç»­è¯»å–
    }
  }
  open() {
    fs.open(this.path, this.flags, (err, fd) =&gt; {
      if (err) {
        return this.emit('error', err)
      }
      this.fd = fd; // å°†æ–‡ä»¶æè¿°ç¬¦ä¿å­˜èµ·æ¥
      this.emit('open', fd)
    })
  }
  read() {
    if (typeof this.fd != 'number') { // ä¿è¯fd ä¸€å®šå­˜åœ¨ï¼Œä¸èƒ½å­˜åœ¨å°±ç­‰ä¼š ä»€ä¹ˆæ—¶å€™å­˜åœ¨å†ç”¨ 
      return this.once('open', () =&gt; this.read())
    }
    // fd ä¸€å®šå­˜åœ¨äº†, bufferæ˜¯å†…å­˜ å†…å­˜æ˜¯å¼•ç”¨ç±»å‹

    const buffer = Buffer.alloc(this.highWaterMark);
    let howMuchToRead = this.end ? Math.min((this.end - this.offset + 1), this.highWaterMark) : this.highWaterMark; // çœŸæ­£è¦è¯»å–çš„ä¸ªæ•°
    fs.read(this.fd, buffer, 0, howMuchToRead, this.offset, (err, bytesRead) =&gt; { // çœŸæ­£è¯»å–åˆ°çš„ä¸ªæ•°
      if (bytesRead) {
        this.offset += bytesRead; // æ¯æ¬¡è¯»åˆ°åå°±ç´¯åŠ ,æ–¹ä¾¿ä¸‹æ¬¡ç»§ç»­è¯»å–
        this.emit('data', buffer.slice(0, bytesRead))
        if (this.flowing) {
          this.read();
        }
      } else {
        this.emit('end');
        if (this.autoClose) {
          fs.close(this.fd, () =&gt; {
            this.emit('close');
          })
        }
      }
    })
  }
}
module.exports = ReadStream;

fs.createReadStream = function(path, options) {
  return new ReadStream(path, options);
};

</code></pre>
<h2 id="æ–‡ä»¶å¯å†™æµçš„ç®€å•å®ç°">æ–‡ä»¶å¯å†™æµçš„ç®€å•å®ç°</h2>
<ul>
<li>ç”¨é“¾è¡¨å¯ä»¥å®ç°æ ˆæˆ–è€…é˜Ÿåˆ—ï¼Œ ä»å¤´éƒ¨è·å–æ•°æ®æ€§èƒ½è¾ƒé«˜ï¼›</li>
<li>ç¬¬ä¸€æ¬¡å†™å…¥æ“ä½œæ˜¯å‘æ–‡ä»¶ä¸­å†™å…¥ ï¼Œåç»­çš„æ“ä½œéƒ½ç¼“å­˜åˆ°é“¾è¡¨ä¸­ï¼›</li>
</ul>
<pre><code class="language-javascript">
const EventEmitter = require('events');
const fs = require('fs');
const Queue = require('./Queue');
class WriteStream extends EventEmitter {
  constructor(path, options = {}) {
    super(options);
    this.path = path;
    this.flags = options.flags || 'w';
    this.encoding = options.encoding || 'utf8';
    this.autoClose = options.autoClose || true;
    this.highWaterMark = options.highWaterMark || 16 * 1024;
    this.open();

    // è¦åˆ¤æ–­æ˜¯ç¬¬ä¸€æ¬¡å†™å…¥ è¿˜æ˜¯ç¬¬äºŒæ¬¡å†™å…¥
    this.writing = false; // ç”¨æ¥æè¿°å½“å‰æ˜¯å¦æœ‰æ­£åœ¨å†™å…¥çš„æ“ä½œ
    this.len = 0; // éœ€è¦çš„ç»Ÿè®¡çš„é•¿åº¦
    this.needDrain = false;// é»˜è®¤æ˜¯å¦è§¦å‘drainäº‹ä»¶
    this.offset = 0; // æ¯æ¬¡å†™å…¥æ—¶çš„åç§»é‡
    this.cache = new Queue// ç”¨æ¥å®ç°ç¼“å­˜çš„
  }
  write(chunk, encoding = this.encoding, cb = () =&gt; { }) { // ç”¨æˆ·è°ƒç”¨çš„writeæ–¹æ³•
    // åˆ¤æ–­æ—¶çœŸçš„å†™å…¥ è¿˜æ˜¯æ”¾åˆ°ç¼“å­˜ä¸­
    // ç”¨æˆ·è°ƒç”¨writeæ—¶ å†™å…¥çš„æ•°æ®å¯èƒ½æ—¶stringOrBuffer
    chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)
    this.len += chunk.length;
    let ret = this.len &lt; this.highWaterMark;
    if (!ret) { // è¾¾åˆ°é¢„æœŸæˆ–è€…è¶…è¿‡é¢„æœŸ å°±æ”¹å˜è§¦å‘drianäº‹ä»¶
      this.needDrain = true;
    }
    if (this.writing) { // å¦‚æœæ­£åœ¨å†™å…¥å°±å…ˆå­˜èµ·æ¥ ç¨åå†å»å†™å…¥
      this.cache.offer({ //f
        chunk,
        encoding,
        cb
      })
    } else {
      this.writing = true;// æ ‡è¯†ä¸ºæ­£åœ¨å†™å…¥
      this._write(chunk, encoding, () =&gt; { // z
        cb(); // ç”¨æˆ·æœ¬æ¥çš„å›è°ƒè¦æ‰§è¡Œ
        this.clearBuffer();
      });
    }
    return ret
  }
  clearBuffer() { // å¯¹ä¸ªå¼‚æ­¥å¹¶å‘ å¯ä»¥è€ƒé˜Ÿåˆ—æ¥å®ç° ä¾æ¬¡æ¸…ç©º
    let data = this.cache.poll();
    if (data) {
      let { chunk, encoding, cb } = data;
      this._write(chunk, encoding, () =&gt; {
        cb();
        this.clearBuffer();
      })
    } else {
      this.writing = false;// ç¼“å­˜ä¸­çš„å†…å®¹ä¹Ÿå†™å…¥äº† æ¸…ç©ºç¼“å­˜
      if (this.needDrain) {
        this.needDrain = false;
        this.emit('drain');
      }
    }
  }
  open() {
    fs.open(this.path, this.flags, (err, fd) =&gt; {
      if (err) return this.emit('error', err);
      this.fd = fd;
      this.emit('open', fd);
    })
  }
  _write(chunk, encoding, cb) { // fs.write =&gt; doWrite
    if (typeof this.fd !== 'number') {
      return this.once('open', () =&gt; this._write(chunk, encoding, cb))
    }
    fs.write(this.fd, chunk, 0, chunk.length, this.offset, (err, written) =&gt; {
      this.len -= written;
      this.offset += written;
      cb();
    })
  }
}
module.exports = WriteStream

fs.createWriteStream = function(path, options) {
  return new WriteStream(path, options);
};

// å®ç°è¯»ä¸€ç‚¹ ï¼ˆon('data') on('end') pause resumeï¼‰ å†™ä¸€ç‚¹   (write,end)

</code></pre>
<h2 id="æ‰‹å†™å®ç°ä¸€ä¸ªé“¾è¡¨">æ‰‹å†™å®ç°ä¸€ä¸ªé“¾è¡¨</h2>
<pre><code class="language-javascript">
class Node {
    constructor(element, next) {
        this.element = element;
        this.next = next;
    }
}
class LinkedList {
    constructor() {
        this.head = null;
        this.size = 0;
    }
    add(index, element) { // å¢åŠ èŠ‚ç‚¹
        if (arguments.length == 1) {
            element = index;
            index = this.size
        }
        if (index &lt; 0 || index &gt; this.size) throw new Error('é“¾è¡¨ç´¢å¼•å¼‚å¸¸');

        if (index == 0) {
            let head = this.head; // è€çš„å¤´
            this.head = new Node(element, head);
        } else {
            let prevNode = this.getNode(index - 1); // è¿™é‡Œå‰é¢èŠ‚ç‚¹è‚¯å®šæœ‰ï¼Œå¦‚æœæ²¡æœ‰ä¼šèµ°if
            prevNode.next = new Node(element, prevNode.next);
        }
        this.size++;
    }
    remove(index) { // åˆ é™¤èŠ‚ç‚¹
        if(this.size == 0) return null
        let oldNode;
        if (index == 0) {
            oldNode = this.head;
            this.head = oldNode &amp;&amp; oldNode.next;
        } else {
            let prevNode = this.getNode(index-1); // è·å–å½“å‰çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ 
            oldNode = prevNode.next; // å‰ä¸€ä¸ªçš„ä¸‹ä¸€ä¸ªå°±æ˜¯è¦åˆ é™¤çš„ 
            prevNode.next = oldNode.next; // è®©å‰ä¸€ä¸ªä¸‹ä¸€ä¸ª æ‰§è¡Œ ä¹‹å‰çš„ä¸‹ä¸€ä¸ª
        }
        this.size--;
        return oldNode.element; // è¿”å›åˆ é™¤å…ƒç´ 
    }
    getNode(index) { // è·å–èŠ‚ç‚¹
        let current = this.head; // ä»å¤´æ‰¾
        for (let i = 0; i &lt; index; i++) {
            current = current.next;
        }
        return current;
    }
    length() { // é“¾è¡¨çš„æ€»ä¸ªæ•°
        return this.size
    }
    reverseLinkedList2(){
        function reverse(head){ // å…ˆé€’å½’æœ€é‡Œé¢çš„ï¼Œåœ¨å‡ºæ¥
            // å¦‚æœé“¾è¡¨ä¸ºç©º æˆ–è€…æ²¡æœ‰ä¸‹ä¸€ä¸ªäº† å°±ä¸ç”¨åè½¬äº†
            if(head == null || head.next == null) return head;
            let newHead = reverse(head.next); // å°†åŸæ¥çš„ä¸‹ä¸€ä¸ªå˜æˆå¤´ç»“ç‚¹
            head.next.next = head; // è®©ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæŒ‡å‘åŸæ¥çš„å¤´
            head.next = null; // è®©è€å¤´æŒ‡å‘null
            return newHead
        }   
        this.head = reverse(this.head)
        return this.head;
    }
    reverseLinkedList(){
        let head = this.head; // ä¿ç•™è€å¤´
        if(head == null || head.next == null) return head;
        let newHead = null; // æ–°çš„é“¾è¡¨å¤´éƒ¨é»˜è®¤æŒ‡å‘null
        while(head!==null){ // å¾ªç¯è€çš„é“¾è¡¨ å°†å†…å®¹ä¾æ¬¡çš„å–å‡ºä½¿ç”¨
            let temp = head.next; // å­˜å‚¨çš„æ˜¯100 
            head.next = newHead;  // è®©è€çš„å¤´æŒ‡å‘æ–°çš„å¤´
            newHead = head; // æ–°çš„å¤´æŒ‡å‘äº†è€çš„å¤´ 
            head = temp; // è€çš„å¤´å‘åç§»åŠ¨
        }
        this.head = newHead;
        return this.head
    }
}
module.exports = LinkedList

</code></pre>
<h2 id="åŸºäºé“¾è¡¨å°è£…é˜Ÿåˆ—">åŸºäºé“¾è¡¨å°è£…é˜Ÿåˆ—</h2>
<pre><code class="language-javascript">
let LinkedList = require('./LinkedList');
class Queue{ // é˜Ÿåˆ—æ˜¯æ·»åŠ å’Œåˆ é™¤
    constructor(){
        this.ll = new LinkedList();
    }
    offer(element){ // å…¥é˜Ÿåˆ—
        this.ll.add(element);
    }
    poll(){
        return this.ll.remove(0);
    }
}
module.exports = Queue;

</code></pre>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">ä¸‹ä¸€ç¯‡</div>
                            <a href="https://feiyayshx.github.io/web-architecture/post/node-buffer/">
                                <h3 class="post-title">
                                    Nodeç³»åˆ—ä¹‹è®¤è¯†Buffer
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">ç›®å½•</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%9B%B8%E5%85%B3%E5%90%8D%E8%AF%8D">ç›¸å…³åè¯</a></li>
<li><a href="#fs%E6%96%B9%E6%B3%95">fsæ–¹æ³•</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E7%AE%80%E5%8D%95%E7%89%88">æ–‡ä»¶æ‹·è´(ç®€å•ç‰ˆ)</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E6%94%B9%E8%BF%9B%E7%89%88">æ–‡ä»¶æ‹·è´(æ”¹è¿›ç‰ˆ)</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E7%BB%88%E6%9E%81%E7%89%88">æ–‡ä»¶æ‹·è´(ç»ˆæç‰ˆ)</a>
<ul>
<li><a href="#fscreatereadstream-%E5%8F%AF%E8%AF%BB%E6%B5%81%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%E5%8F%8A%E7%94%A8%E6%B3%95">fs.createReadStream å¯è¯»æµå†…éƒ¨å®ç°è¿‡ç¨‹åŠç”¨æ³•</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%8F%AF%E8%AF%BB%E6%B5%81">åˆ›å»ºå¯è¯»æµ</a></li>
<li><a href="#%E7%9B%91%E5%90%ACdata%E4%BA%8B%E4%BB%B6">ç›‘å¬dataäº‹ä»¶</a></li>
<li><a href="#%E7%9B%91%E5%90%ACend%E4%BA%8B%E4%BB%B6">ç›‘å¬endäº‹ä»¶</a></li>
<li><a href="#%E7%9B%91%E5%90%ACerror%E4%BA%8B%E4%BB%B6">ç›‘å¬erroräº‹ä»¶</a></li>
<li><a href="#%E7%9B%91%E5%90%ACopen%E4%BA%8B%E4%BB%B6">ç›‘å¬openäº‹ä»¶</a></li>
<li><a href="#%E7%9B%91%E5%90%ACcolse%E4%BA%8B%E4%BB%B6">ç›‘å¬colseäº‹ä»¶</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AE%E7%BC%96%E7%A0%81">è®¾ç½®ç¼–ç </a></li>
<li><a href="#%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E8%A7%A6%E5%8F%91data">æš‚åœå’Œæ¢å¤è§¦å‘data</a></li>
</ul>
</li>
<li><a href="#fscreatewritestream-%E5%8F%AF%E5%86%99%E6%B5%81%E7%94%A8%E6%B3%95">fs.createWriteStream å¯å†™æµç”¨æ³•</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%8F%AF%E5%86%99%E6%B5%81">åˆ›å»ºå¯å†™æµ</a></li>
<li><a href="#write-%E6%96%B9%E6%B3%95">write() æ–¹æ³•</a></li>
<li><a href="#end-%E6%96%B9%E6%B3%95">end() æ–¹æ³•</a></li>
<li><a href="#drain-%E6%96%B9%E6%B3%95">drain() æ–¹æ³•</a></li>
<li><a href="#finish-%E6%96%B9%E6%B3%95">finish() æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#%E5%80%9F%E5%8A%A9fs%E6%A8%A1%E5%9D%97%E6%8F%90%E4%BE%9B%E7%9A%84%E5%8F%AF%E8%AF%BB%E6%B5%81%E4%B8%8E%E5%8F%AF%E5%86%99%E6%B5%81%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E6%8B%B7%E8%B4%9D">å€ŸåŠ©fsæ¨¡å—æä¾›çš„å¯è¯»æµä¸å¯å†™æµæ–¹æ³•å®ç°æ‹·è´</a></li>
</ul>
</li>
<li><a href="#%E6%96%87%E4%BB%B6%E5%8F%AF%E8%AF%BB%E6%B5%81%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0">æ–‡ä»¶å¯è¯»æµçš„ç®€å•å®ç°</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E5%8F%AF%E5%86%99%E6%B5%81%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0">æ–‡ä»¶å¯å†™æµçš„ç®€å•å®ç°</a></li>
<li><a href="#%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%93%BE%E8%A1%A8">æ‰‹å†™å®ç°ä¸€ä¸ªé“¾è¡¨</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E%E9%93%BE%E8%A1%A8%E5%B0%81%E8%A3%85%E9%98%9F%E5%88%97">åŸºäºé“¾è¡¨å°è£…é˜Ÿåˆ—</a></li>
</ul>
</li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*è·å–æ–‡ç« ç›®å½•é›†åˆ,å¯é€šè¿‡:headerè¿‡æ»¤å™¨*/
                var alis = $('.post-content :header');
                /*è·å–ä¾§è¾¹æ ç›®å½•åˆ—è¡¨é›†åˆ**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*è·å–æ»šåŠ¨æ¡åˆ°é¡¶éƒ¨çš„è·ç¦»*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*è·å–é”šç‚¹é›†åˆä¸­çš„å…ƒç´ åˆ†åˆ«åˆ°é¡¶ç‚¹çš„è·ç¦»*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*é«˜äº®æ˜¾ç¤º*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*ç»‘å®šæ»šåŠ¨äº‹ä»¶ */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://feiyayshx.github.io/web-architecture/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
</body>

</html>